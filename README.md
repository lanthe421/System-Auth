# Система Аутентификации и Авторизации

Кастомная система аутентификации и авторизации, построенная на FastAPI и PostgreSQL. Система реализует гибкую модель управления доступом на основе ролей (RBAC) с поддержкой как ролевых, так и прямых пользовательских разрешений.

## Возможности

- **Управление пользователями**: Регистрация, аутентификация, обновление профиля и мягкое удаление
- **Управление доступом на основе ролей (RBAC)**: Гибкая система разрешений с ролями и прямыми пользовательскими разрешениями
- **JWT Аутентификация**: Безопасная токен-based аутентификация с refresh токенами
- **Управление сессиями**: Инвалидация токенов и поддержка выхода из системы
- **Admin API**: Полный набор эндпоинтов для управления ролями, разрешениями и назначениями пользователей
- **Property-Based тестирование**: Обширное покрытие тестами с использованием Hypothesis для гарантий корректности
- **Демонстрационные ресурсы**: Примеры эндпоинтов, демонстрирующие работу авторизации

## Содержание

- [Структура проекта](#структура-проекта)
- [Схема базы данных](#схема-базы-данных)
- [Модель управления доступом](#модель-управления-доступом)
- [Инструкции по установке](#инструкции-по-установке)
- [Переменные окружения](#переменные-окружения)
- [API Эндпоинты](#api-эндпоинты)
- [Примеры запросов](#примеры-запросов)
- [Тестирование](#тестирование)
- [Соображения безопасности](#соображения-безопасности)

## Структура проекта

```
.
├── app/
│   ├── api/                    # API эндпоинты
│   │   ├── auth.py            # Эндпоинты аутентификации
│   │   ├── users.py           # Эндпоинты управления пользователями
│   │   ├── admin.py           # Админские эндпоинты для ролей/разрешений
│   │   ├── resources.py       # Демонстрационные эндпоинты ресурсов
│   │   ├── dependencies.py    # FastAPI зависимости (auth, authorization)
│   │   └── schemas.py         # Pydantic модели запросов/ответов
│   ├── models/                 # SQLAlchemy модели
│   │   ├── user.py            # Модель пользователя
│   │   ├── role.py            # Модель роли
│   │   ├── permission.py      # Модель разрешения
│   │   ├── session.py         # Модель сессии
│   │   └── mock_resources.py  # Модели демонстрационных ресурсов
│   ├── repositories/           # Слой доступа к данным
│   │   ├── user_repository.py
│   │   ├── role_repository.py
│   │   ├── permission_repository.py
│   │   └── session_repository.py
│   ├── services/               # Бизнес-логика
│   │   ├── auth_service.py    # Логика аутентификации
│   │   ├── user_service.py    # Логика управления пользователями
│   │   ├── role_service.py    # Логика управления ролями
│   │   └── permission_service.py  # Логика проверки разрешений
│   ├── utils/                  # Вспомогательные функции
│   │   ├── jwt.py             # Генерация/валидация JWT токенов
│   │   └── password.py        # Хеширование/проверка паролей
│   ├── config.py               # Управление конфигурацией
│   ├── database.py             # Настройка подключения к БД
│   ├── exceptions.py           # Пользовательские классы исключений
│   ├── error_handlers.py       # Глобальные обработчики ошибок
│   └── main.py                 # Точка входа FastAPI приложения
├── alembic/                    # Миграции базы данных
│   └── versions/               # Скрипты миграций
├── tests/                      # Тестовые файлы
│   ├── conftest.py            # Pytest фикстуры
│   ├── test_auth_service.py   # Тесты аутентификации (включая PBT)
│   ├── test_user_service.py   # Тесты управления пользователями (включая PBT)
│   ├── test_authorization_service.py  # Тесты авторизации (включая PBT)
│   └── ...                    # Другие тестовые файлы
├── .kiro/specs/auth-system/    # Документы спецификации
│   ├── requirements.md         # Требования системы
│   ├── design.md              # Документ дизайна со свойствами корректности
│   └── tasks.md               # Список задач реализации
├── requirements.txt            # Python зависимости
├── .env.example               # Пример переменных окружения
├── seed.py                    # Скрипт заполнения БД
└── README.md                  # Этот файл
```

## Схема базы данных

Система использует PostgreSQL со следующими основными таблицами:

### Основные таблицы

**users** (пользователи)
- Хранит информацию об учетных записях пользователей
- Поля: id, first_name, last_name, middle_name, email (уникальный), password_hash, is_active, timestamps
- Мягкое удаление через флаг `is_active`

**roles** (роли)
- Именованные коллекции разрешений
- Поля: id, name (уникальное), description, created_at
- Примеры: "admin", "user", "moderator"

**permissions** (разрешения)
- Специфические комбинации ресурс-действие
- Поля: id, resource, action, description
- Уникальное ограничение на (resource, action)
- Примеры: ("documents", "read"), ("projects", "create")

**sessions** (сессии)
- Активные сессии аутентификации
- Поля: id, user_id, token_hash, expires_at, is_valid, created_at
- Используется для инвалидации токенов при выходе

### Таблицы связей

**user_roles** (многие-ко-многим)
- Связывает пользователей с ролями
- Поля: user_id, role_id, assigned_at

**role_permissions** (многие-ко-многим)
- Связывает роли с разрешениями
- Поля: role_id, permission_id

**user_permissions** (многие-ко-многим)
- Прямые разрешения пользователей (в обход ролей)
- Поля: user_id, permission_id, granted_at

### Индексы

- `idx_users_email`: Быстрый поиск по email для аутентификации
- `idx_users_active`: Фильтрация активных/неактивных пользователей
- `idx_sessions_token`: Быстрая валидация токенов
- `idx_sessions_user`: Запросы сессий пользователя
- `idx_sessions_expiry`: Очистка истекших сессий

## Модель управления доступом

Система реализует гибкую модель RBAC с двумя источниками разрешений:

### Источники разрешений

1. **Разрешения на основе ролей**: Пользователи наследуют все разрешения от назначенных ролей
2. **Прямые разрешения**: Специфические разрешения, предоставленные напрямую пользователям

### Оценка разрешений

При проверке, может ли пользователь выполнить действие:
1. Проверяется, есть ли у пользователя разрешение через любую назначенную роль
2. Проверяется, есть ли у пользователя разрешение, предоставленное напрямую
3. Доступ предоставляется, если любой из источников предоставляет разрешение (логика объединения)

### Примеры сценариев

**Сценарий 1: Доступ на основе роли**
- Пользователь имеет роль "editor"
- Роль "editor" имеет разрешения: documents:read, documents:create, documents:update
- Пользователь может выполнять все три действия с документами

**Сценарий 2: Прямое разрешение**
- Пользователь имеет роль "user" (только разрешения на чтение)
- Администратор предоставляет прямое разрешение: reports:create
- Пользователь может читать большинство ресурсов (через роль) И создавать отчеты (через прямое разрешение)

**Сценарий 3: Объединение разрешений**
- Пользователь имеет роль "user" с documents:read
- Администратор также предоставляет прямое разрешение: documents:read
- Пользователь имеет доступ через оба источника (избыточно, но допустимо)

### Роль администратора

Система включает специальную роль "admin", которая:
- Имеет все разрешения по умолчанию
- Может получать доступ к админским API эндпоинтам
- Может управлять ролями, разрешениями и назначениями пользователей
- Не может быть удалена (контролируется в коде)

## Инструкции по установке

### Требования

- Python 3.9 или выше
- PostgreSQL 12 или выше
- pip (менеджер пакетов Python)

### Шаги установки

1. **Клонируйте репозиторий** (если применимо):
```bash
git clone <repository-url>
cd auth-system
```

2. **Создайте виртуальное окружение**:
```bash
python -m venv venv

# На Linux/Mac:
source venv/bin/activate

# На Windows:
venv\Scripts\activate
```

3. **Установите зависимости**:
```bash
pip install -r requirements.txt
```

4. **Настройте переменные окружения**:
```bash
# Скопируйте файл-пример
cp .env.example .env

# Отредактируйте .env с вашими настройками
# Как минимум, обновите DATABASE_URL и SECRET_KEY
```

5. **Настройте базу данных**:
```bash
# Создайте базу данных (убедитесь, что PostgreSQL запущен)
createdb auth_db

# Запустите миграции для создания таблиц
alembic upgrade head

# Заполните базу данных начальными данными
python seed.py
```

Скрипт заполнения создает:
- **Роль Admin** со всеми разрешениями (documents, projects, reports: read, create, update, delete)
- **Роль User** с разрешениями только на чтение
- **12 разрешений**, покрывающих CRUD операции на 3 типах ресурсов
- **Начального администратора**: 
  - Email: `admin@example.com`
  - Пароль: `admin123`
  - **⚠️ ВАЖНО**: Измените этот пароль сразу после первого входа!

6. **Запустите приложение**:
```bash
uvicorn app.main:app --reload
```

API будет доступно по адресу `http://localhost:8000`

7. **Доступ к документации API**:
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

## Переменные окружения

Создайте файл `.env` в корне проекта со следующими переменными:

| Переменная | Описание | Пример | Обязательна |
|----------|-------------|---------|----------|
| `DATABASE_URL` | Строка подключения PostgreSQL | `postgresql://user:pass@localhost:5432/auth_db` | Да |
| `SECRET_KEY` | Секретный ключ для подписи JWT | `your-secret-key-change-in-production` | Да |
| `ALGORITHM` | Алгоритм JWT | `HS256` | Да |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | Время жизни access токена | `30` | Да |
| `REFRESH_TOKEN_EXPIRE_DAYS` | Время жизни refresh токена | `7` | Да |
| `BCRYPT_ROUNDS` | Фактор стоимости хеширования пароля | `12` | Да |
| `APP_NAME` | Название приложения | `Auth System` | Нет |
| `DEBUG` | Включить режим отладки | `True` или `False` | Нет |

**Примечания по безопасности**:
- Сгенерируйте надежный `SECRET_KEY` для продакшена (используйте `openssl rand -hex 32`)
- Никогда не коммитьте файл `.env` в систему контроля версий
- Используйте специфичные для окружения значения для разных развертываний
- Увеличьте `BCRYPT_ROUNDS` для повышения безопасности (более медленное хеширование)

## API Эндпоинты

### Эндпоинты аутентификации

| Метод | Эндпоинт | Описание | Требуется аутентификация |
|--------|----------|-------------|---------------|
| POST | `/api/auth/register` | Регистрация нового пользователя | Нет |
| POST | `/api/auth/login` | Вход и получение токенов | Нет |
| POST | `/api/auth/logout` | Выход и инвалидация токена | Да |
| POST | `/api/auth/refresh` | Обновление access токена | Да (refresh токен) |

### Эндпоинты управления пользователями

| Метод | Эндпоинт | Описание | Требуется аутентификация |
|--------|----------|-------------|---------------|
| GET | `/api/users/me` | Получить профиль текущего пользователя | Да |
| PUT | `/api/users/me` | Обновить профиль текущего пользователя | Да |
| DELETE | `/api/users/me` | Мягко удалить учетную запись текущего пользователя | Да |

### Админские эндпоинты (требуется роль Admin)

**Управление ролями**
| Метод | Эндпоинт | Описание |
|--------|----------|-------------|
| GET | `/api/admin/roles` | Список всех ролей |
| POST | `/api/admin/roles` | Создать новую роль |
| GET | `/api/admin/roles/{role_id}` | Получить детали роли |
| PUT | `/api/admin/roles/{role_id}` | Обновить разрешения роли |
| DELETE | `/api/admin/roles/{role_id}` | Удалить роль |

**Управление разрешениями**
| Метод | Эндпоинт | Описание |
|--------|----------|-------------|
| GET | `/api/admin/permissions` | Список всех разрешений |
| POST | `/api/admin/permissions` | Создать новое разрешение |
| GET | `/api/admin/permissions/{permission_id}` | Получить детали разрешения |
| DELETE | `/api/admin/permissions/{permission_id}` | Удалить разрешение |

**Назначение ролей пользователям**
| Метод | Эндпоинт | Описание |
|--------|----------|-------------|
| POST | `/api/admin/users/{user_id}/roles/{role_id}` | Назначить роль пользователю |
| DELETE | `/api/admin/users/{user_id}/roles/{role_id}` | Отозвать роль у пользователя |

**Назначение разрешений пользователям**
| Метод | Эндпоинт | Описание |
|--------|----------|-------------|
| POST | `/api/admin/users/{user_id}/permissions/{permission_id}` | Предоставить прямое разрешение |
| DELETE | `/api/admin/users/{user_id}/permissions/{permission_id}` | Отозвать прямое разрешение |

### Эндпоинты демонстрационных ресурсов

| Метод | Эндпоинт | Описание | Требуемое разрешение |
|--------|----------|-------------|---------------------|
| GET | `/api/resources/documents` | Список демонстрационных документов | `documents:read` |
| GET | `/api/resources/projects` | Список демонстрационных проектов | `projects:read` |
| GET | `/api/resources/reports` | Список демонстрационных отчетов | `reports:read` |

## Примеры запросов

### 1. Регистрация нового пользователя

```bash
curl -X POST http://localhost:8000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "first_name": "John",
    "last_name": "Doe",
    "email": "john.doe@example.com",
    "password": "SecurePass123!",
    "password_confirm": "SecurePass123!"
  }'
```

**Response (201 Created)**:
```json
{
  "id": 2,
  "first_name": "John",
  "last_name": "Doe",
  "middle_name": null,
  "email": "john.doe@example.com",
  "is_active": true,
  "created_at": "2024-01-15T10:30:00"
}
```

### 2. Вход в систему

```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "john.doe@example.com",
    "password": "SecurePass123!"
  }'
```

**Response (200 OK)**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

### 3. Получение профиля текущего пользователя

```bash
curl -X GET http://localhost:8000/api/users/me \
  -H "Authorization: Bearer <access_token>"
```

**Response (200 OK)**:
```json
{
  "id": 2,
  "first_name": "John",
  "last_name": "Doe",
  "middle_name": null,
  "email": "john.doe@example.com",
  "is_active": true,
  "created_at": "2024-01-15T10:30:00"
}
```

### 4. Обновление профиля пользователя

```bash
curl -X PUT http://localhost:8000/api/users/me \
  -H "Authorization: Bearer <access_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "first_name": "Jane",
    "middle_name": "Marie"
  }'
```

**Response (200 OK)**:
```json
{
  "id": 2,
  "first_name": "Jane",
  "last_name": "Doe",
  "middle_name": "Marie",
  "email": "john.doe@example.com",
  "is_active": true,
  "created_at": "2024-01-15T10:30:00"
}
```

### 5. Создание роли (только для администратора)

```bash
curl -X POST http://localhost:8000/api/admin/roles \
  -H "Authorization: Bearer <admin_access_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "editor",
    "description": "Can read and edit documents",
    "permission_ids": [1, 2, 3]
  }'
```

**Response (201 Created)**:
```json
{
  "id": 3,
  "name": "editor",
  "description": "Can read and edit documents",
  "permissions": [
    {
      "id": 1,
      "resource": "documents",
      "action": "read",
      "description": "Read documents"
    },
    {
      "id": 2,
      "resource": "documents",
      "action": "create",
      "description": "Create documents"
    },
    {
      "id": 3,
      "resource": "documents",
      "action": "update",
      "description": "Update documents"
    }
  ]
}
```

### 6. Назначение роли пользователю (только для администратора)

```bash
curl -X POST http://localhost:8000/api/admin/users/2/roles/3 \
  -H "Authorization: Bearer <admin_access_token>"
```

**Response (200 OK)**:
```json
{
  "message": "Role assigned successfully"
}
```

### 7. Доступ к защищенному ресурсу

```bash
curl -X GET http://localhost:8000/api/resources/documents \
  -H "Authorization: Bearer <access_token>"
```

**Response (200 OK)** - if user has `documents:read` permission:
```json
[
  {
    "id": 1,
    "title": "Project Proposal",
    "content": "This is a sample document...",
    "author": "Admin"
  },
  {
    "id": 2,
    "title": "Meeting Notes",
    "content": "Notes from the team meeting...",
    "author": "Admin"
  }
]
```

**Response (403 Forbidden)** - if user lacks permission:
```json
{
  "detail": "Insufficient permissions"
}
```

### 8. Выход из системы

```bash
curl -X POST http://localhost:8000/api/auth/logout \
  -H "Authorization: Bearer <access_token>"
```

**Response (200 OK)**:
```json
{
  "message": "Successfully logged out"
}
```

## Тестирование

Проект включает всестороннее покрытие тестами, включая модульные тесты и property-based тесты.

### Запуск тестов

**Запустить все тесты**:
```bash
pytest
```

**Запустить с подробным выводом**:
```bash
pytest -v
```

**Запустить конкретный тестовый файл**:
```bash
pytest tests/test_auth_service.py
```

**Запустить только property-based тесты**:
```bash
pytest -v -k "property"
```

**Запустить с отчетом о покрытии**:
```bash
pytest --cov=app --cov-report=html
```

### Структура тестов

- **Модульные тесты**: Тестируют отдельные функции и методы с конкретными входными данными
- **Property-Based тесты**: Используют Hypothesis для тестирования свойств корректности на множестве случайных входных данных
- **Интеграционные тесты**: Тестируют end-to-end потоки API

### Property-Based тестирование

Система использует Hypothesis для property-based тестирования для проверки 24 свойств корректности, определенных в документе дизайна. Каждый property тест:
- Выполняет 100+ итераций со случайно сгенерированными тестовыми данными
- Проверяет универсальные свойства, которые должны выполняться для всех допустимых входных данных
- Помечен соответствующим номером свойства из дизайна

Примеры тестируемых свойств:
- Хеширование пароля никогда не сохраняет открытый текст
- Валидная регистрация всегда создает активную учетную запись
- Назначение роли предоставляет все разрешения роли
- Выход инвалидирует токены
- Проверка разрешений оценивает как ролевые, так и прямые разрешения

## Соображения безопасности

### Безопасность аутентификации

- **Хранение паролей**: Пароли хешируются с использованием bcrypt с настраиваемым фактором стоимости
- **Безопасность токенов**: JWT токены с коротким временем истечения (30 минут по умолчанию)
- **Refresh токены**: Токены с более длительным сроком действия для получения новых access токенов
- **Управление сессиями**: Токены могут быть инвалидированы при выходе
- **Сравнение с постоянным временем**: Проверка пароля использует безопасное по времени сравнение

### Безопасность авторизации

- **Отказ по умолчанию**: Проверки разрешений отклоняют доступ по умолчанию
- **Принцип наименьших привилегий**: Новые пользователи получают минимальные разрешения
- **Мягкое удаление**: Данные пользователей сохраняются для целей аудита
- **Защита администратора**: Роль администратора не может быть удалена

### Безопасность API

- **Валидация входных данных**: Все входные данные валидируются с помощью Pydantic моделей
- **Защита от SQL инъекций**: SQLAlchemy ORM с параметризованными запросами
- **CORS**: Настройте разрешенные источники соответствующим образом для продакшена
- **Ограничение частоты запросов**: Рекомендуется для эндпоинтов аутентификации (не реализовано)
- **HTTPS**: Требуется для продакшен развертываний

### Рекомендации для продакшена

1. **Немедленно измените учетные данные администратора по умолчанию**
2. **Используйте надежный SECRET_KEY** (сгенерируйте с помощью `openssl rand -hex 32`)
3. **Включите HTTPS** и перенаправляйте HTTP трафик
4. **Настройте CORS** с конкретными разрешенными источниками
5. **Реализуйте ограничение частоты запросов** на эндпоинтах аутентификации
6. **Настройте мониторинг** неудачных попыток входа
7. **Регулярные аудиты безопасности** и обновления зависимостей
8. **Используйте конфигурации, специфичные для окружения**
9. **Включите резервное копирование базы данных**
10. **Регулярно проверяйте и ротируйте токены**

## Устранение неполадок

### Проблемы с подключением к базе данных

**Ошибка**: `could not connect to server`
- Убедитесь, что PostgreSQL запущен: `pg_ctl status`
- Проверьте DATABASE_URL в файле `.env`
- Убедитесь, что база данных существует: `psql -l`

### Проблемы с миграциями

**Ошибка**: `Target database is not up to date`
- Запустите миграции: `alembic upgrade head`
- Проверьте историю миграций: `alembic current`

### Проблемы с аутентификацией

**Ошибка**: `401 Unauthorized`
- Убедитесь, что токен включен в заголовок Authorization
- Проверьте, что токен не истек
- Убедитесь, что учетная запись пользователя активна (is_active=True)

**Ошибка**: `403 Forbidden`
- Пользователю не хватает требуемого разрешения
- Проверьте роли и прямые разрешения пользователя
- Убедитесь, что разрешение существует в базе данных

### Ошибки импорта

**Ошибка**: `ModuleNotFoundError`
- Активируйте виртуальное окружение
- Установите зависимости: `pip install -r requirements.txt`

## Лицензия

[Укажите вашу лицензию здесь]

## Вклад в проект

[Добавьте руководство по внесению вклада, если применимо]

## Поддержка

По вопросам и проблемам:
- Проверьте документацию API по адресу `/docs`
- Просмотрите документы спецификации в `.kiro/specs/auth-system/`
- [Добавьте контактную информацию или ссылку на трекер проблем]
